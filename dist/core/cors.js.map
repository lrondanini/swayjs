{"version":3,"file":"cors.js","sourceRoot":"","sources":["../../src/core/cors.ts"],"names":[],"mappings":";;AAOA,+BAAwB;AAqCxB,MAAqB,WAAW;IAE9B,YAAY,OAAqB;QAC/B,IAAG,OAAO,EAAE,CAAC;YACX,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACzB,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,OAAO,GAAG;gBACb,MAAM,EAAE,GAAG;gBACX,OAAO,EAAE,gCAAgC;gBACzC,iBAAiB,EAAE,KAAK;gBACxB,oBAAoB,EAAE,GAAG;aAC1B,CAAC;QACJ,CAAC;IAGH,CAAC;IACO,QAAQ,CAAC,CAAC;QAChB,OAAO,OAAO,CAAC,KAAK,QAAQ,IAAI,CAAC,YAAY,MAAM,CAAC;IACtD,CAAC;IAGO,oBAAoB,CAAC,YAA2C;QACtE,IAAI,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,EAAE,CAAC;YAChC,OAAO,YAAY,CAAC;QACtB,CAAC;aAAM,IAAI,YAAY,EAAE,CAAC;YACxB,OAAO,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAChC,CAAC;QACD,OAAO,SAAS,CAAC;IACnB,CAAC;IAEO,eAAe,CAAC,MAAM,EAAE,aAAa;QAC3C,IAAI,KAAK,CAAC,OAAO,CAAC,aAAa,CAAC,EAAE,CAAC;YACjC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,aAAa,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAC9C,IAAI,IAAI,CAAC,eAAe,CAAC,MAAM,EAAE,aAAa,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;oBACnD,OAAO,IAAI,CAAC;gBACd,CAAC;YACH,CAAC;YACD,OAAO,KAAK,CAAC;QACf,CAAC;aAAM,IAAI,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,EAAE,CAAC;YACxC,OAAO,MAAM,KAAK,aAAa,CAAC;QAClC,CAAC;aAAM,IAAI,aAAa,YAAY,MAAM,EAAE,CAAC;YAC3C,OAAO,aAAa,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACpC,CAAC;aAAM,CAAC;YACN,OAAO,CAAC,CAAC,aAAa,CAAC;QACzB,CAAC;IACH,CAAC;IAEO,eAAe,CAAC,GAAG;QACzB,IAAI,aAAa,GAAG,GAAG,CAAC,OAAO,CAAC,MAAM,EACpC,OAAO,GAAe,EAAE,EACxB,SAAS,CAAC;QAEZ,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;YAExD,OAAO,CAAC,IAAI,CAAC,CAAC;oBACZ,GAAG,EAAE,6BAA6B;oBAClC,KAAK,EAAE,GAAG;iBACX,CAAC,CAAC,CAAC;QACN,CAAC;aAAM,IAAI,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;YAE9C,OAAO,CAAC,IAAI,CAAC,CAAC;oBACZ,GAAG,EAAE,6BAA6B;oBAClC,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM;iBAC3B,CAAC,CAAC,CAAC;YACJ,OAAO,CAAC,IAAI,CAAC,CAAC;oBACZ,GAAG,EAAE,MAAM;oBACX,KAAK,EAAE,QAAQ;iBAChB,CAAC,CAAC,CAAC;QACN,CAAC;aAAM,CAAC;YACN,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,aAAa,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;YAErE,OAAO,CAAC,IAAI,CAAC,CAAC;oBACZ,GAAG,EAAE,6BAA6B;oBAClC,KAAK,EAAE,SAAS,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC,KAAK;iBACzC,CAAC,CAAC,CAAC;YACJ,OAAO,CAAC,IAAI,CAAC,CAAC;oBACZ,GAAG,EAAE,MAAM;oBACX,KAAK,EAAE,QAAQ;iBAChB,CAAC,CAAC,CAAC;QACN,CAAC;QAED,OAAO,OAAO,CAAC;IACjB,CAAC;IAEO,YAAY,CAAC,OAAO,EAAE,GAAG;QAC/B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;YAC/C,IAAI,MAAM,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;YACxB,IAAI,MAAM,EAAE,CAAC;gBACX,IAAI,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;oBAC1B,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;gBACjC,CAAC;qBAAM,IAAI,MAAM,CAAC,GAAG,KAAK,MAAM,IAAI,MAAM,CAAC,KAAK,EAAE,CAAC;oBACjD,IAAA,cAAI,EAAC,GAAG,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC;gBAC1B,CAAC;qBAAM,IAAI,MAAM,CAAC,KAAK,EAAE,CAAC;oBACxB,GAAG,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC;gBAC1C,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IAEO,gBAAgB;QACtB,IAAI,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC;QACnC,OAAO,GAAG,IAAI,CAAC,oBAAoB,CAAC,OAAO,CAAC,CAAC;QAC7C,OAAO;YACL,GAAG,EAAE,8BAA8B;YACnC,KAAK,EAAE,OAAO;SACf,CAAC;IACJ,CAAC;IAEO,oBAAoB;QAC1B,IAAI,IAAI,CAAC,OAAO,CAAC,WAAW,KAAK,IAAI,EAAE,CAAC;YACtC,OAAO;gBACL,GAAG,EAAE,kCAAkC;gBACvC,KAAK,EAAE,MAAM;aACd,CAAC;QACJ,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAEO,uBAAuB,CAAC,GAAG;QACjC,IAAI,cAAc,GAAG,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;QAC5E,IAAI,OAAO,GAAe,EAAE,CAAC;QAE7B,IAAI,CAAC,cAAc,EAAE,CAAC;YACpB,cAAc,GAAG,GAAG,CAAC,OAAO,CAAC,gCAAgC,CAAC,CAAC;YAC/D,OAAO,CAAC,IAAI,CAAC,CAAC;oBACZ,GAAG,EAAE,MAAM;oBACX,KAAK,EAAE,gCAAgC;iBACxC,CAAC,CAAC,CAAC;QACN,CAAC;QACD,IAAI,cAAc,IAAI,cAAc,CAAC,MAAM,EAAE,CAAC;YAC5C,OAAO,CAAC,IAAI,CAAC,CAAC;oBACZ,GAAG,EAAE,8BAA8B;oBACnC,KAAK,EAAE,cAAc;iBACtB,CAAC,CAAC,CAAC;QACN,CAAC;QAED,OAAO,OAAO,CAAC;IACjB,CAAC;IAEO,uBAAuB;QAC7B,IAAI,OAAO,GAAG,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;QACrE,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,OAAO,IAAI,CAAC;QACd,CAAC;QACD,IAAI,OAAO,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;YAC9B,OAAO;gBACL,GAAG,EAAE,+BAA+B;gBACpC,KAAK,EAAE,OAAO;aACf,CAAC;QACJ,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAEQ,eAAe;QACtB,IAAI,MAAM,GAAG,CAAC,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,KAAK,QAAQ,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAA;QAC/G,IAAI,MAAM,IAAI,MAAM,CAAC,MAAM,EAAE,CAAC;YAC5B,OAAO;gBACL,GAAG,EAAE,wBAAwB;gBAC7B,KAAK,EAAE,MAAM;aACd,CAAC;QACJ,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAGD,aAAa,CAAC,GAAoB,EAAE,GAAmB;QACrD,IAAI,OAAO,GAAQ,EAAE,CAAC;QACtB,MAAM,MAAM,GAAG,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,CAAC,WAAW,IAAI,GAAG,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC;QAEhF,IAAI,MAAM,KAAK,SAAS,EAAE,CAAC;YAEzB,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC;YACxC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,oBAAoB,EAAE,CAAC,CAAA;YACzC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC,CAAA;YACrC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,GAAG,CAAC,CAAC,CAAC;YAChD,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC,CAAA;YACpC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,CAAC,CAAA;YAC5C,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;YAEhC,IAAI,IAAI,CAAC,OAAO,CAAC,iBAAiB,EAAE,CAAC;YAErC,CAAC;iBAAM,CAAC;gBAGN,GAAG,CAAC,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,oBAAoB,IAAI,GAAG,CAAC;gBAC1D,GAAG,CAAC,SAAS,CAAC,gBAAgB,EAAE,GAAG,CAAC,CAAC;gBACrC,GAAG,CAAC,GAAG,EAAE,CAAC;gBACV,OAAO,KAAK,CAAC;YACf,CAAC;QACH,CAAC;aAAM,CAAC;YAEN,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC;YACxC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,oBAAoB,EAAE,CAAC,CAAA;YACzC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,CAAC,CAAA;YAC5C,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;QAClC,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;CAEF;AAxMD,8BAwMC","sourcesContent":["/*\nThis code snippet is based on the \"expressjs/cors\" project (https://github.com/expressjs/cors) licensed under the MIT License.\n\nfor types:  https://github.com/DefinitelyTyped/DefinitelyTyped licensed under the MIT License.\n*/\n\nimport { IncomingMessage, ServerResponse } from \"http\";\nimport vary from 'vary';\n\nexport type StaticOrigin = boolean | string | RegExp | Array<boolean | string | RegExp>;\n\nexport type CustomOrigin = (\n  requestOrigin: string | undefined,\n  callback: (err: Error | null, origin?: StaticOrigin) => void,\n) => void;\n\nexport interface CorsOptions {\n  /**\n   * @default '*''\n   */\n  origin?: StaticOrigin | CustomOrigin | undefined;\n  /**\n   * @default 'GET,HEAD,PUT,PATCH,POST,DELETE'\n   */\n  methods?: string | string[] | undefined;\n  allowedHeaders?: string | string[] | undefined;\n  exposedHeaders?: string | string[] | undefined;\n  credentials?: boolean | undefined;\n  maxAge?: number | undefined;\n  /**\n   * @default false\n   */\n  preflightContinue?: boolean | undefined;\n  /**\n   * @default 204\n   */\n  optionsSuccessStatus?: number | undefined;\n}\n\nexport type Header = {\n  key: string;\n  value: string;\n}\n\nexport default class CorsManager {\n  options: CorsOptions;\n  constructor(options?: CorsOptions) {\n    if(options) {\n      this.options = options;\n    } else {\n      this.options = {\n        origin: '*',\n        methods: 'GET,HEAD,PUT,PATCH,POST,DELETE',\n        preflightContinue: false,\n        optionsSuccessStatus: 204\n      };\n    }\n    \n\n  }\n  private isString(s) {\n    return typeof s === 'string' || s instanceof String;\n  }\n\n\n  private headerOptionToString(headerOption: string | string[] | undefined): string | undefined {\n    if (this.isString(headerOption)) {\n      return headerOption;\n    } else if (headerOption) {\n      return headerOption.join(',');\n    }\n    return undefined;\n  }\n\n  private isOriginAllowed(origin, allowedOrigin) {\n    if (Array.isArray(allowedOrigin)) {\n      for (var i = 0; i < allowedOrigin.length; ++i) {\n        if (this.isOriginAllowed(origin, allowedOrigin[i])) {\n          return true;\n        }\n      }\n      return false;\n    } else if (this.isString(allowedOrigin)) {\n      return origin === allowedOrigin;\n    } else if (allowedOrigin instanceof RegExp) {\n      return allowedOrigin.test(origin);\n    } else {\n      return !!allowedOrigin;\n    }\n  }\n\n  private configureOrigin(req) {\n    var requestOrigin = req.headers.origin,\n      headers: Header[][] = [],\n      isAllowed;\n\n    if (!this.options.origin || this.options.origin === '*') {\n      // allow any origin\n      headers.push([{\n        key: 'Access-Control-Allow-Origin',\n        value: '*'\n      }]);\n    } else if (this.isString(this.options.origin)) {\n      // fixed origin\n      headers.push([{\n        key: 'Access-Control-Allow-Origin',\n        value: this.options.origin\n      }]);\n      headers.push([{\n        key: 'Vary',\n        value: 'Origin'\n      }]);\n    } else {\n      isAllowed = this.isOriginAllowed(requestOrigin, this.options.origin);\n      // reflect origin\n      headers.push([{\n        key: 'Access-Control-Allow-Origin',\n        value: isAllowed ? requestOrigin : false\n      }]);\n      headers.push([{\n        key: 'Vary',\n        value: 'Origin'\n      }]);\n    }\n\n    return headers;\n  }\n\n  private applyHeaders(headers, res) {\n    for (var i = 0, n = headers.length; i < n; i++) {\n      var header = headers[i];\n      if (header) {\n        if (Array.isArray(header)) {\n          this.applyHeaders(header, res);\n        } else if (header.key === 'Vary' && header.value) {\n          vary(res, header.value);\n        } else if (header.value) {\n          res.setHeader(header.key, header.value);\n        }\n      }\n    }\n  }\n\n  private configureMethods() {\n    var methods = this.options.methods;\n    methods = this.headerOptionToString(methods);\n    return {\n      key: 'Access-Control-Allow-Methods',\n      value: methods\n    };\n  }\n\n  private configureCredentials() {\n    if (this.options.credentials === true) {\n      return {\n        key: 'Access-Control-Allow-Credentials',\n        value: 'true'\n      };\n    }\n    return null;\n  }\n\n  private configureAllowedHeaders(req) {\n    var allowedHeaders = this.headerOptionToString(this.options.allowedHeaders);\n    var headers: Header[][] = [];\n\n    if (!allowedHeaders) {\n      allowedHeaders = req.headers['access-control-request-headers']; // .headers wasn't specified, so reflect the request headers\n      headers.push([{\n        key: 'Vary',\n        value: 'Access-Control-Request-Headers'\n      }]);\n    } \n    if (allowedHeaders && allowedHeaders.length) {\n      headers.push([{\n        key: 'Access-Control-Allow-Headers',\n        value: allowedHeaders\n      }]);\n    }\n\n    return headers;\n  }\n\n  private configureExposedHeaders() {\n    var headers = this.headerOptionToString(this.options.exposedHeaders);\n    if (!headers) {\n      return null;\n    } \n    if (headers && headers.length) {\n      return {\n        key: 'Access-Control-Expose-Headers',\n        value: headers\n      };\n    }\n    return null;\n  }\n\n  private  configureMaxAge() {\n    var maxAge = (typeof this.options.maxAge === 'number' || this.options.maxAge) && this.options.maxAge.toString()\n    if (maxAge && maxAge.length) {\n      return {\n        key: 'Access-Control-Max-Age',\n        value: maxAge\n      };\n    }\n    return null;\n  }\n\n\n  handleRequest(req: IncomingMessage, res: ServerResponse): boolean {\n    var headers: any = [];\n    const method = req.method && req.method.toUpperCase && req.method.toUpperCase();\n\n    if (method === 'OPTIONS') {\n      // preflight\n      headers.push(this.configureOrigin(req));\n      headers.push(this.configureCredentials())\n      headers.push(this.configureMethods())\n      headers.push(this.configureAllowedHeaders(req));\n      headers.push(this.configureMaxAge())\n      headers.push(this.configureExposedHeaders())\n      this.applyHeaders(headers, res);\n\n      if (this.options.preflightContinue) {\n        \n      } else {\n        // Safari (and potentially other browsers) need content-length 0,\n        //   for 204 or they just hang waiting for a body\n        res.statusCode = this.options.optionsSuccessStatus || 204;\n        res.setHeader('Content-Length', '0');\n        res.end();\n        return false;\n      }\n    } else {\n      // actual response\n      headers.push(this.configureOrigin(req));\n      headers.push(this.configureCredentials())\n      headers.push(this.configureExposedHeaders())\n      this.applyHeaders(headers, res);\n    }\n\n    return true;\n  }\n\n}\n"]}